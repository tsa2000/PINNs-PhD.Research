import time
import urllib

print("ðŸš€ Preparing the Robust Mobile Link (Cloudflare)...")

# 1. ØªØ«Ø¨ÙŠØª Streamlit ÙÙ‚Ø·
!pip install -q streamlit

# 2. ØªØ­Ù…ÙŠÙ„ ÙˆØªØ´ØºÙŠÙ„ Cloudflare Tunnel (Ø£ÙƒØ«Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ø§Ù‹ Ù…Ù† localtunnel)
!wget -q -O cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
!chmod +x cloudflared
!./cloudflared tunnel --url http://localhost:8501 &>/dev/null &

# 3. ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
!streamlit run app.py &>/dev/null &

# 4. Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø·
time.sleep(5)
try:
    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ø§Ø¨Ø· Ø§Ù„Ù†ÙÙ‚
    cf_url = !grep -o 'https://.*\.trycloudflare.com' nohup.out 2>/dev/null | head -n 1
    # Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠØ¸Ù‡Ø± ÙÙŠ nohup
    if not cf_url:
        import requests
        # Ù†Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù†ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ø§Ù„Ù†ÙÙ‚
        time.sleep(3)
        print("ðŸ”— Waiting for tunnel...")
        # (Ù‡Ù†Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø£Ù† ÙƒÙ„Ø§ÙˆØ¯ ÙÙ„ÙŠØ± ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©ØŒ Ø³Ù†Ø¹Ø·ÙŠÙƒ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¸Ù‡Ø±)
        
    print("\nâœ… SUCCESS! Click this link to view on your phone:")
    # Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ø³ÙŠØ·Ø¨Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØµØ­ÙŠØ­ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    !ps aux | grep cloudflared | grep trycloudflare
    # Ø£Ùˆ Ø³Ù†Ø¬Ø±Ø¨ Ø·Ø¨Ø§Ø¹ØªÙ‡ Ù…Ù† Ù…Ù„Ù Ø§Ù„Ù„ÙˆØ¬ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
    !cat /root/.cloudflared/config.yml 2>/dev/null
    
    print("\nðŸ‘‡ ðŸ‘‡ ðŸ‘‡ CLICK THIS LINK ðŸ‘‡ ðŸ‘‡ ðŸ‘‡")
    !grep -o 'https://.*\.trycloudflare.com' /content/nohup.out 2>/dev/null || echo "Searching..."
    # Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®ÙŠØ±Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø¯Ù‚Ø©
    !pkill cloudflared
    !nohup ./cloudflared tunnel --url http://localhost:8501 > tunnel_log.txt 2>&1 &
    time.sleep(4)
    !grep -o 'https://.*\.trycloudflare.com' tunnel_log.txt
    
except Exception as e:
    print(f"Error: {e}")

print("\nðŸ’¡ Tip: This link works directly on Safari (No password needed).")
